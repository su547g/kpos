<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta id="viewport" name="viewport" content="width=320; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="apple-touch-fullscreen" content="yes" />

    <script type="text/javascript" src="xml2json.js"></script>
    <script type="text/javascript" src="kpos.js"></script>
    <script type="text/javascript" src="popup.js"></script>
    <script type="text/javascript" src="js/dragAndDrop.js"></script>
    <style type="text/css">
        .drag {
            position: relative;
        }
    </style>
</head>
<body onload="InitDragDrop()">
<table>
	<tr><td><input type="button" class="navibutton" onclick="window.location.href='home.html';" value="<< Back"></td>
</table>
<table width="100%">
	<tr>
		<td width="100%">
			<div>
				<div style="width: 5px; float: left;">
					<table id="areaList">
						
					</table>
				</div>
				<div id="pageContainer" style="outline:solid black thin; width: 700px; height: 500px; background-color: gray; float: left"></div>
				<div style="width: 5px; float: left;">&nbsp;</div>
				<textarea id="log" style="outline:solid black thin; width: 150px; height: 300px; background-color: gray; float: left"></textarea>
			</div>
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td>
			Table Name: <input type="text" id="tableName" value=""/>
			<button onclick="addTable()" id="addTableButton" style="padding: 5px">New Table</button>
			<button onclick="getLocations()" id="getLocationsButton" style="padding: 5px">Locations</button>
		</td>
	</tr>
	<tr>
		<td>
			<button onclick="saveTable()" id="saveTableButton" style="padding: 5px">Save Table</button>
			<button onclick="deleteTable()" id="deleteTableButton" style="padding: 5px">Delete Table</button>
		</td>
	</tr>
</table>
<script type="text/javascript">
    var tableNum = 0;
	var tables = {};
	var selected = null;
	var savedTable = null;
	
    function addTable() {
		var tableName = document.getElementById('tableName').value;
		if(tableName != null && tableName != "") {
			if(tables[tableName] != null) {
				alert("Table name already exists!"); return;
			}
			var container = document.getElementById('pageContainer');
	        var tableDiv = document.createElement('div');
			//tableDiv.setAttribute('src', 'img/tan-square.png');
	        tableDiv.setAttribute('class', 'drag');
			var top = 5 - (tableNum++ * 75);
	        tableDiv.setAttribute('id', tableName);
	        tableDiv.setAttribute('style', 'outline:solid black medium; width: 80px; height: 80px; background-color: brown;left: 5px;top: ' + top + 'px;');
	        tableDiv.innerHTML = '<br><center>' + tableName + '</center>';
	        tableDiv.onclick = function() { clickTable(tableName); }
	        container.appendChild(tableDiv);
	        document.getElementById('tableName').value = "";
	        tables[tableName] = new Table(null, tableName, 0, 0, null); //aId, aName, aX, aY, aAreaId
	        selected = tableName;
	        clickTable(tableName);
	   } else {
	   		alert("Please enter a table name");
	   }
    }
	function clickTable(id) {
		var tableDiv = document.getElementById(id);
		document.getElementById('tableName').value = id;
		tableDiv.style.backgroundColor = "yellow";
		selected = id;
		for(var t in tables) {
			if(tables[t].name != id) {
				document.getElementById(t).style.backgroundColor = "brown";
			}
		}
	}
    function getLocations() {
        var container = document.getElementById('pageContainer');
        var log = document.getElementById('log');
        var tables = document.getElementsByClassName('drag');
        var containerLeft = container.offsetLeft;
        var containerTop = container.offsetTop;

        var buffer = '';
        for(var i = 0; i < tableIds.length; i++) {
            var table = document.getElementById(tableIds[i]);
            console.log("table x: " + (table.offsetLeft - containerLeft) + " table y: " + (table.offsetTop - containerTop));
            buffer += 'x: ' + (table.offsetLeft - containerLeft) + ' y: ' + (table.offsetTop - containerTop) + '\n';
        }
        log.innerHTML = buffer;
    }
    function saveTable() {
    	var tableDiv = document.getElementById(selected); 
    	if(tableDiv != null) {
    		var table = tables[selected];
    		table.x = table.offsetLeft - containerLeft;
    		table.y = table.offsetTop - containerTop;
    		var soapType = new SaveTableType(table);
    		call_web_service(soapType, saveTableHandler);
    		document.getElementById("saveTableButton").disabled = true;
    		document.getElementById("deleteTableButton").disabled = true;
    		savedTable = table;
    	}
    }
    function saveTableHandler(jsonObj) {
    	if(jsonObj != undefined && jsonObj != null &&
			jsonObj.savetableresponsetype != undefined && jsonObj.savetableresponsetype != null && 
			jsonObj.savetableresponsetype.result.successful == "true") {
			var id = jsonObj.savetableresponsetype.tableid;
			savedTable.id = id;
			savedTable = null;
		} else {
			alert("Failed to save table: " + jsonObj.savetableresponsetype.result.failurereason);
		}
		document.getElementById("saveTableButton").disabled = false;
		document.getElementById("deleteTableButton").disabled = false;
    }
    function deleteTable() {
    	var tableDiv = document.getElementById(selected); 
    	if(tableDiv != null) {
    		var table = tables[selected];
    		savedTable = table;
    		if(table.id != null) {
    			var soapType = new DeleteTableType(table.id);
    			call_web_service(soapType, deleteTableHandler);
    		} else {
    			tableDiv.parent.removeChild(tableDiv);
    		}
    	}
    }
    function deleteTableHandler(jsonObj) {
    	if(jsonObj != undefined && jsonObj != null &&
			jsonObj.deletetableresponsetype != undefined && jsonObj.deletetableresponsetype != null && 
			jsonObj.deletetableresponsetype.result.successful == "true") {
			var div = document.getElementById(savedTable.name);
			div.parent.removeChild(tableDiv);
		} else {
			alert("Failed to delete table!");
		}
    }
</script>
</body>
</html>